@using TaskFlow.Client.Services
@inject NavigationManager Navigation
@inject AuthService AuthService
@inject NotificationService NotifService
@inject LanguageService Lang
@implements IDisposable

<nav class="navbar navbar-expand-lg navbar-dark bg-dark shadow-sm">
    <div class="container">
        <a class="navbar-brand d-flex align-items-center gap-2" href="/">
            <span class="d-inline-flex align-items-center justify-content-center rounded-2"
                  style="width:32px;height:32px;background:linear-gradient(135deg,#4f46e5,#7c3aed);font-size:0.9rem;">
                <i class="bi bi-kanban text-white"></i>
            </span>
            TaskFlow
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <AuthorizeView>
                <Authorized>
                    <ul class="navbar-nav me-auto ms-lg-3">
                        <li class="nav-item">
                            <NavLink class="nav-link" href="/tasks" Match="NavLinkMatch.All">
                                <i class="bi bi-check2-square me-1"></i> @Lang.Get("nav.tasks")
                            </NavLink>
                        </li>
                        <li class="nav-item">
                            <NavLink class="nav-link position-relative" href="/notifications">
                                <i class="bi bi-bell"></i>
                                @if (unreadCount > 0)
                                {
                                    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger"
                                          style="font-size: 0.6rem;">
                                        @(unreadCount > 99 ? "99+" : unreadCount)
                                    </span>
                                }
                            </NavLink>
                        </li>
                    </ul>
                    <ul class="navbar-nav align-items-center">
                        <li class="nav-item me-2">
                            <div class="lang-toggle">
                                <button class="@(Lang.IsFrench ? "active" : "")" @onclick='() => Lang.SetLanguage("fr")'>FR</button>
                                <button class="@(!Lang.IsFrench ? "active" : "")" @onclick='() => Lang.SetLanguage("en")'>EN</button>
                            </div>
                        </li>
                        <li class="nav-item">
                            <span class="nav-link text-light opacity-75">
                                <i class="bi bi-person-circle me-1"></i>@context.User.Identity?.Name
                            </span>
                        </li>
                        <li class="nav-item">
                            <button class="btn btn-outline-light btn-sm ms-2" @onclick="Logout">
                                <i class="bi bi-box-arrow-right me-1"></i>@Lang.Get("nav.logout")
                            </button>
                        </li>
                    </ul>
                </Authorized>
                <NotAuthorized>
                    <ul class="navbar-nav ms-auto align-items-center">
                        <li class="nav-item me-2">
                            <div class="lang-toggle">
                                <button class="@(Lang.IsFrench ? "active" : "")" @onclick='() => Lang.SetLanguage("fr")'>FR</button>
                                <button class="@(!Lang.IsFrench ? "active" : "")" @onclick='() => Lang.SetLanguage("en")'>EN</button>
                            </div>
                        </li>
                        <li class="nav-item">
                            <NavLink class="nav-link" href="/login">@Lang.Get("nav.signin")</NavLink>
                        </li>
                        <li class="nav-item ms-2">
                            <a href="/register" class="btn btn-primary btn-sm">@Lang.Get("nav.getstarted")</a>
                        </li>
                    </ul>
                </NotAuthorized>
            </AuthorizeView>
        </div>
    </div>
</nav>

@code {
    private int unreadCount;
    private Timer? _pollingTimer;

    protected override void OnInitialized()
    {
        Lang.OnLanguageChanged += OnLangChanged;
        _pollingTimer = new Timer(async _ =>
        {
            try
            {
                unreadCount = await NotifService.GetUnreadCountAsync();
                await InvokeAsync(StateHasChanged);
            }
            catch { }
        }, null, TimeSpan.Zero, TimeSpan.FromSeconds(30));
    }

    private void OnLangChanged() => InvokeAsync(StateHasChanged);

    private async Task Logout()
    {
        await AuthService.LogoutAsync();
        unreadCount = 0;
        Navigation.NavigateTo("/login");
    }

    public void Dispose()
    {
        Lang.OnLanguageChanged -= OnLangChanged;
        _pollingTimer?.Dispose();
    }
}
